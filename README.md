# 深入理解Java虚拟机 JVM高级特性与最佳实践
# 第五章 类文件结构
## Class类文件的结构
```
Class文件是一组以8位字节为基础单位的二进制流，各个数据项目严格按照顺序紧凑地排列在Class文件之中，中间
没有添加任何分隔符，这使得整个Class文件中存储的内容几乎全部是程序运行的必要数据，没有空隙存在。当遇到
需要占用8位字节以上空间的数据项时，则会按照高位在前的方式分割成若干个8位字节进行存储。
根据Java虚拟机规范规定，Class文件格式采用一种类似于C语言结构体的伪结构来存储数据，这种伪结构只有两种
数据类型:无符号数和表，后面的解析都要以这两种数据类型为基础。
Class的结构不像XML等描述语言，由于它没有任何分隔符号，所以上面的Class类文件结构表中的数据项，无论是顺序
还是数量，甚至于数据存储的字节序这样的细节，都是被严格限定的，代表的含义，长度是多少，先后顺序等，都不
允许改变。
```
* 无符号数
```
无符号数属于基本的数据类型，以u1、u2、u4、u8来分别代表1个字节、2个字节、4个字节和8个字节的无符号数，
无符号数可以用来描述数字、索引引用、数量值或者按照UTF-8编码构成字符串值。
```
* 表
```
表是由多个无符号数或者其它表作为数据项构成的复合数据类型，所有表都习惯性地以"_info"结尾。
表用于描述有层次关系的复合结构的数据，整个Class文件本质上就是一张表。
```
## 表中各个数据项的含义
* 魔数(Magic Number)
```
每个Class文件的头4个字节称为魔数,它的唯一作用是确定这个文件是否为一个能被虚拟机接受的Class文件。
使用魔数而不是扩展名来进行识别主要是基于安全方面考虑，因为扩展名可以随意更改。
Class文件的魔数很有"浪漫气息"，值为:0xCAFEBABE,很像咖啡宝贝。
```
* Class文件的版本
```
紧接着魔数的4个字节存储的是Class文件的版本号。
第5和第6个字节是次版本号(Minor Version),第7和第8字节是主版本号(Major Version)。
Java的版本号是从45开始的。高版本的JDK能向下兼容以前的版本，但不向上兼容。
```
* 常量池
```
紧接着主次版本号之后的第9字节是常量池入口，常量池可以理解为Class文件之中的资源仓库，它是Class文件结构中
与其它项目关联最多的数据类型，也是占用Class文件空间最大的数据项目之一，同时它还是在Class文件中第一个
出现表类型的数据项目。
常量池中主要存放两大类常量:字面量(Literal)和符号引用(Symbolic References)。
字面量比较接近于Java语言层面的常量概念，如文本字符串、声明为final的常量值等。
符号引用则属于编译原理方面的概念，包括三类常量：
1. 类和接口的全限定名(Full Qualified Name)
2. 字段的名称和描述符(Descriptor)
3. 方法的名称和描述符
Java代码在进行编译的时候，没有像C和C++那样有"连接"这一步，而是在虚拟机加载Class文件的时候进行动态连接。
也就是说，在Class文件中不会保存各个方法、字段的最终内存布局信息，当虚拟机运行时，需要从常量池获得对应
的符号引用，再在类创建时或运行时解析、翻译到具体的内存地址之中。
常量池中每一项常量都是一个表，这14种表都有一个共同的特点，就是表开始的第一位是一个u1类型的标志位，代表
当前这个常量属于哪种常量类型。
```
